from django.utils.crypto import get_random_string
from django.urls import reverse
from django.core.mail import EmailMessage
from django.conf import settings
from django.utils import timezone
from datetime import timedelta

def send_verification_email(user):
    # generate a unique verification token
    token = get_random_string(length=32)

    # save the token and the current timestamp in the database
    user.email_verification_token = token
    user.email_verification_sent_at = timezone.now()
    user.save()

    # create the verification URL
    verification_url = reverse('verify_email', args=[token])

    # create the email message
    subject = 'Verify your email address'
    message = f'Click on the following link to verify your email address: {settings.BASE_URL}{verification_url}'
    from_email = settings.DEFAULT_FROM_EMAIL
    to_email = user.email
    email = EmailMessage(subject, message, from_email, [to_email])

    # send the email message
    email.send()

def verify_email(request, token):
    # check if the token is valid and not expired
    user = User.objects.filter(email_verification_token=token).first()
    if user and user.email_verification_sent_at > timezone.now() - timedelta(days=1):
        user.email_verified = True
        user.save()
        return render(request, 'email_verification_success.html')
    else:
        return render(request, 'email_verification_failure.html')
